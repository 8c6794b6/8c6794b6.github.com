<!DOCTYPE html>
<html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=defice-width, initial-scale=1"> <title>8c6794b6.github.io</title> <link href="/css/style.css" rel="stylesheet" type="text/css" /> <link href="http://fonts.googleapis.com/css?family=Noto+Serif" rel="stylesheet" type="text/css" /> <link href="http://fonts.googleapis.com/css?family=PT+Serif" rel="stylesheet" type="text/css" /> <link rel="icon" type="image/png" href="/static/favicon.png"/>  </head> <body> <header> <h1><a href="/index.html">8c6794b6.github.io</a></h1> <nav> <a href="/index.html">HOME</a> • <a href="/about.html">ABOUT</a> • <a href="/archive.html">ARCHIVE</a> • <a href="/rss.xml">RSS</a> </nav> </header> <div class="contents"> <div class="post-title"> <h2>Adhoc update of ugen parameters</h2> <em class="post-date">2011-10-25</em> </div> <div class="post"> <p>Adhoc update of UGen parameters, with generic functions.</p>

<p>Requires ghc 7.0 or higher:</p>

<pre><code><span class="code"><span class="atom">&gt;</span> <span class="comment">{-# LANGUAGE DeriveDataTypeable, StandaloneDeriving #-}</span>
<span class="atom">&gt;</span> <span class="comment">{-# LANGUAGE TypeSynonymInstances #-}</span>
<span class="atom">&gt;</span>
<span class="atom">&gt;</span> <span class="keyword">module</span> <span class="variable">AdhocUpdate</span> <span class="keyword">where</span>
<span class="atom">&gt;</span>
<span class="atom">&gt;</span> <span class="keyword">import</span> <span class="variable">Control</span><span class="atom">.</span><span class="variable">Monad</span>
<span class="atom">&gt;</span> <span class="keyword">import</span> <span class="variable">Data</span><span class="atom">.</span><span class="variable">Data</span> <span class="paren1">(<span class="code"><span class="variable">Data,</span> <span class="variable">Typeable</span></span>)</span>
<span class="atom">&gt;</span> <span class="keyword">import</span> <span class="variable">Data</span><span class="atom">.</span><span class="variable">Generics</span> <span class="paren1">(<span class="code">everywhere, mkT</span>)</span>
<span class="atom">&gt;</span> <span class="keyword">import</span> <span class="variable">Data</span><span class="atom">.</span><span class="variable">List</span> <span class="paren1">(<span class="code">zipWith4</span>)</span>
<span class="atom">&gt;</span> <span class="keyword">import</span> <span class="variable">Control</span><span class="atom">.</span><span class="variable">Concurrent</span> <span class="paren1">(<span class="code">forkIO, threadDelay</span>)</span>
<span class="atom">&gt;</span> <span class="keyword">import</span> <span class="variable">System</span><span class="atom">.</span><span class="variable">Random</span>
<span class="atom">&gt;</span>
<span class="atom">&gt;</span> <span class="keyword">import</span> <span class="variable">Sound</span><span class="atom">.</span><span class="variable">SC3</span>
<span class="atom">&gt;</span> <span class="keyword">import</span> <span class="variable">Sound</span><span class="atom">.</span><span class="variable">SC3</span><span class="atom">.</span><span class="variable">ID</span>
<span class="atom">&gt;</span> <span class="keyword">import</span> <span class="variable">Data</span><span class="atom">.</span><span class="variable">Generics</span><span class="atom">.</span><span class="variable">Uniplate</span><span class="atom">.</span><span class="variable">Data</span> <span class="paren1">(<span class="code">transform, transformM</span>)</span></span></code></pre>

<p>To play sound example, run:</p>

<pre><code>| $ scsynth -u 57110
</code></pre>

<p>before invoking OSC sending actions.</p>

<p>We have a synth named <code>s01</code>, written with unit generator function from
hsc3.</p>

<pre><code><span class="code"><span class="atom">&gt;</span> s01 <span class="keyword">::</span> <span class="variable">UGen</span>
<span class="atom">&gt;</span> s01 <span class="keyword">=</span>
<span class="atom">&gt;</span>   <span class="keyword">let</span> o <span class="keyword">=</span> control <span class="variable">IR</span> <span class="string">"out"</span> 0
<span class="atom">&gt;</span>       p <span class="keyword">=</span> control <span class="variable">KR</span> <span class="string">"pan"</span> 0
<span class="atom">&gt;</span>       f <span class="keyword">=</span> control <span class="variable">KR</span> <span class="string">"freq"</span> 440
<span class="atom">&gt;</span>       d <span class="keyword">=</span> control <span class="variable">KR</span> <span class="string">"decay"</span> 1
<span class="atom">&gt;</span>       e <span class="keyword">=</span> linen <span class="paren1">(<span class="code">impulse <span class="variable">KR</span> 0<span class="atom">.</span>1 0</span>)</span> 1e<span class="atom">-</span>2 1 d <span class="variable">RemoveSynth</span>
<span class="atom">&gt;</span>       s <span class="keyword">=</span> pan2 <span class="paren1">(<span class="code">sinOsc <span class="variable">AR</span> f 0 <span class="atom">*</span> e <span class="atom">*</span> 0<span class="atom">.</span>3</span>)</span> p 1
<span class="atom">&gt;</span>   <span class="keyword">in</span>  out o s</span></code></pre>

<p>Actions to make sound with <code>s01</code>:</p>

<pre><code><span class="code"><span class="atom">&gt;</span> prepare <span class="keyword">::</span> <span class="variable">IO</span> <span class="paren1">(<span class="code"></span>)</span>
<span class="atom">&gt;</span> prepare <span class="keyword">=</span> withSC3 reset
<span class="atom">&gt;</span>
<span class="atom">&gt;</span> play_s01a <span class="keyword">::</span> <span class="variable">IO</span> <span class="paren1">(<span class="code"></span>)</span>
<span class="atom">&gt;</span> play_s01a <span class="keyword">=</span> audition s01</span></code></pre>

<p>Play it:</p>

<pre><code>| *AdhocUpdate&gt; parepare &gt;&gt; play_s01a
</code></pre>

<p>It makes 440 Hz sine tone, with 1 second decay time, positioning center.
There are 4 control parameters in s01: out, pan, freq, and decay. What
we want to do is to use different values for these parameters. It is
possible to set different value by:</p>

<ul>
<li>Send above synthdef to scsynth server</li>
<li>Wait till the server load the synthdef</li>
<li>Send <code>s_new</code> message to play the synthdef with new parameters</li>
</ul>

<p>We can send <code>s_new</code> message with only those parameters which we want to
update.</p>

<pre><code><span class="code"><span class="atom">&gt;</span> play_s01b <span class="keyword">=</span> withSC3 <span class="atom">$</span> <span class="keyword">\</span>fd <span class="keyword">-&gt;</span> <span class="keyword">do</span>
<span class="atom">&gt;</span>   async fd <span class="paren1">(<span class="code">d_recv <span class="atom">$</span> synthdef <span class="string">"s01"</span> s01</span>)</span>
<span class="atom">&gt;</span>   send fd <span class="atom">$</span> s_new <span class="string">"s01"</span> <span class="paren1">(<span class="code"><span class="atom">-</span>1</span>)</span> <span class="variable">AddToTail</span> 1 <span class="paren1">[<span class="code"><span class="paren2">(<span class="code"><span class="string">"freq"</span>,3300</span>)</span>,<span class="paren2">(<span class="code"><span class="string">"decay"</span>,0<span class="atom">.</span>3</span>)</span></span>]</span></span></code></pre>

<p>Is there any other way to do this? We can pass parameters as function
arguments:</p>

<pre><code><span class="code"><span class="atom">&gt;</span> s01' o p f d <span class="keyword">=</span>
<span class="atom">&gt;</span>   <span class="keyword">let</span> e <span class="keyword">=</span> linen <span class="paren1">(<span class="code">impulse <span class="variable">KR</span> 0<span class="atom">.</span>1 0</span>)</span> 1e<span class="atom">-</span>2 1 d <span class="variable">RemoveSynth</span>
<span class="atom">&gt;</span>       s <span class="keyword">=</span> pan2 <span class="paren1">(<span class="code">sinOsc <span class="variable">AR</span> f 0 <span class="atom">*</span> e <span class="atom">*</span> 0<span class="atom">.</span>3</span>)</span> p 1
<span class="atom">&gt;</span>   <span class="keyword">in</span>  out o s</span></code></pre>

<p>But in this manner, we need to specify all values.</p>

<pre><code><span class="code"><span class="atom">&gt;</span> play_s01c <span class="keyword">=</span> audition <span class="atom">$</span> s01' 0 0 3300 0<span class="atom">.</span>3</span></code></pre>

<p>Can we update specified values only, without sending synthdef, like:</p>

<pre><code><span class="code"><span class="atom">&gt;</span> play_s01d <span class="keyword">=</span> audition <span class="atom">$</span> ups <span class="string">"freq"</span> 3300 <span class="atom">$</span> ups <span class="string">"decay"</span> 0<span class="atom">.</span>3 s01</span></code></pre>

<p>We can do this with functions in generic modules.</p>

<p>UGen data is defined as:</p>

<pre><code>| data UGen
|   = Constant {constantValue :: Double}
|   | Control {controlOperatingRate :: Rate,
|              controlName :: String,
|              controlDefault :: Double,
|              controlTriggered :: Bool}
|   | Primitive {ugenRate :: Rate,
|                ugenName :: String,
|                ugenInputs :: [UGen],
|                ugenOutputs :: [Output],
|                ugenSpecial :: Special,
|                ugenId :: Int}
|   | Proxy {proxySource :: UGen, proxyIndex :: Int}
|   | MCE {mceProxies :: [UGen]}
|   | MRG {mrgLeft :: UGen, mrgRight :: UGen}
</code></pre>

<p>We use <code>Data</code> and <code>Typeable</code> instances for data types used inside <code>UGen</code>
graph. In hsc3-0.9, <code>UGen</code> is not defined as instance of Data. Using
<code>StandaloneDeriving</code> LANGUAGE pragma to avoid writing boiler plate
codes.</p>

<pre><code><span class="code"><span class="atom">&gt;</span> <span class="keyword">deriving</span> <span class="keyword">instance</span> <span class="variable">Data</span> <span class="variable">UGen</span>
<span class="atom">&gt;</span> <span class="keyword">deriving</span> <span class="keyword">instance</span> <span class="variable">Typeable</span> <span class="variable">UGen</span>
<span class="atom">&gt;</span> <span class="keyword">deriving</span> <span class="keyword">instance</span> <span class="variable">Data</span> <span class="variable">Rate</span>
<span class="atom">&gt;</span> <span class="keyword">deriving</span> <span class="keyword">instance</span> <span class="variable">Typeable</span> <span class="variable">Rate</span>
<span class="atom">&gt;</span> <span class="keyword">deriving</span> <span class="keyword">instance</span> <span class="variable">Data</span> <span class="variable">Special</span>
<span class="atom">&gt;</span> <span class="keyword">deriving</span> <span class="keyword">instance</span> <span class="variable">Typeable</span> <span class="variable">Special</span>
<span class="atom">&gt;</span> <span class="keyword">deriving</span> <span class="keyword">instance</span> <span class="variable">Data</span> <span class="variable">UGenId</span>
<span class="atom">&gt;</span> <span class="keyword">deriving</span> <span class="keyword">instance</span> <span class="variable">Typeable</span> <span class="variable">UGenId</span></span></code></pre>

<p>We want to update <code>UGen</code> with <code>Control</code> constructor only, and only if
specified parameter name has matched. This could be done with using
<code>everywhere</code> from syb.</p>

<pre><code><span class="code"><span class="atom">&gt;</span> ups <span class="keyword">::</span> <span class="variable">String</span> <span class="keyword">-&gt;</span> <span class="variable">Double</span> <span class="keyword">-&gt;</span> <span class="variable">UGen</span> <span class="keyword">-&gt;</span> <span class="variable">UGen</span>
<span class="atom">&gt;</span> ups key value ug <span class="keyword">=</span> everywhere <span class="paren1">(<span class="code">mkT f</span>)</span> ug <span class="keyword">where</span>
<span class="atom">&gt;</span>   f <span class="paren1">(<span class="code"><span class="variable">Control</span> r key' _ t</span>)</span> <span class="keyword">|</span> key <span class="atom">==</span> key' <span class="keyword">=</span> <span class="variable">Control</span> r key value t
<span class="atom">&gt;</span>   f x                    <span class="keyword">=</span> x</span></code></pre>

<p>Play updated sound:</p>

<pre><code><span class="code"><span class="atom">&gt;</span> play_s01e <span class="keyword">=</span> audition <span class="atom">.</span> ups <span class="string">"freq"</span> 3300 <span class="atom">.</span> ups <span class="string">"decay"</span> 0<span class="atom">.</span>3 <span class="atom">$</span> s01</span></code></pre>

<p>Or, using <code>transform</code> from uniplate package.</p>

<pre><code><span class="code"><span class="atom">&gt;</span> upu <span class="keyword">::</span> <span class="variable">String</span> <span class="keyword">-&gt;</span> <span class="variable">Double</span> <span class="keyword">-&gt;</span> <span class="variable">UGen</span> <span class="keyword">-&gt;</span> <span class="variable">UGen</span>
<span class="atom">&gt;</span> upu key value ug <span class="keyword">=</span> transform f ug <span class="keyword">where</span>
<span class="atom">&gt;</span>   f <span class="paren1">(<span class="code"><span class="variable">Control</span> r key' _ t</span>)</span> <span class="keyword">|</span> key <span class="atom">==</span> key' <span class="keyword">=</span> <span class="variable">Control</span> r key value t
<span class="atom">&gt;</span>   f x                    <span class="keyword">=</span> x</span></code></pre>

<p>We can use in same manner as ups.</p>

<pre><code><span class="code"><span class="atom">&gt;</span> play_s01e' <span class="keyword">=</span> audition <span class="atom">.</span> upu <span class="string">"freq"</span> 3300 <span class="atom">.</span> upu <span class="string">"decay"</span> 0<span class="atom">.</span>3 <span class="atom">$</span> s01</span></code></pre>

<p>How's its performance? Since we need to traverse synth structure and
find out whether control name matches or not, it should spend more time
than raw messaging style.</p>

<p>Simple grain sound, 1ms decay time sine tone in message sending style:</p>

<pre><code><span class="code"><span class="atom">&gt;</span> play_s01f x <span class="keyword">=</span>
<span class="atom">&gt;</span>   withSC3 <span class="atom">.</span> flip send <span class="atom">.</span> s_new <span class="string">"s01"</span> <span class="paren1">(<span class="code"><span class="atom">-</span>1</span>)</span> <span class="variable">AddToTail</span> 1 <span class="atom">$</span>
<span class="atom">&gt;</span>   <span class="paren1">[<span class="code"><span class="paren2">(<span class="code"><span class="string">"freq"</span>,x</span>)</span>,<span class="paren2">(<span class="code"><span class="string">"decay"</span>,0<span class="atom">.</span>001</span>)</span></span>]</span></span></code></pre>

<p>And in generic updating style:</p>

<pre><code><span class="code"><span class="atom">&gt;</span> play_s01g x <span class="keyword">=</span> audition <span class="atom">$</span> upu <span class="string">"freq"</span> x <span class="atom">.</span> upu <span class="string">"decay"</span> 0<span class="atom">.</span>001 <span class="atom">$</span> s01</span></code></pre>

<p>Grain generator with 500 nano seconds interval.</p>

<pre><code><span class="code"><span class="atom">&gt;</span> mkgrn k <span class="keyword">=</span>
<span class="atom">&gt;</span>   sequence_ <span class="atom">$</span> map <span class="paren1">(<span class="code">k <span class="atom">&gt;=&gt;</span> const <span class="paren2">(<span class="code">threadDelay 500</span>)</span></span>)</span> <span class="paren1">[<span class="code">10000,9931<span class="keyword">..</span>0</span>]</span></span></code></pre>

<p>Message sending style:</p>

<pre><code><span class="code"><span class="atom">&gt;</span> grn01 <span class="keyword">::</span> <span class="variable">IO</span> <span class="paren1">(<span class="code"></span>)</span>
<span class="atom">&gt;</span> grn01 <span class="keyword">=</span> mkgrn play_s01f</span></code></pre>

<p>Generic update style:</p>

<pre><code><span class="code"><span class="atom">&gt;</span> grn02 <span class="keyword">::</span> <span class="variable">IO</span> <span class="paren1">(<span class="code"></span>)</span>
<span class="atom">&gt;</span> grn02 <span class="keyword">=</span> mkgrn play_s01g</span></code></pre>

<p>Note that, difference is not only coming from parameter update. In
<code>play_s01g</code>, entire new synthdef need to be sent to server, this
synthdef sending is not so quick to do in 500 nano seconds.</p>

<p>From performance perspective, message passing style is superior to
generic updating style. This is same in SClang, described in
<a href="http://supercollider.svn.sourceforge.net/viewvc/supercollider/trunk/common/build/Help/ServerArchitecture/NodeMessaging.html" >NodeMessaging SC help
file</a>.</p>

<p>There's different use cases for generic update.</p>

<p>One is, sending variation of synthdefs. When we know that only fixed
variation of parameters are used for certain synthdef, we can send
multiple synthdef with different default values in advance. This
approach resembles to <code>variants</code> concepts, shown in <a href="http://supercollider.svn.sourceforge.net/viewvc/supercollider/trunk/common/build/Help/ServerArchitecture/SynthDef.html" >SynthDef SC help
file</a>.</p>

<pre><code><span class="code"><span class="atom">&gt;</span> prepare_s01_variants <span class="keyword">::</span> <span class="variable">IO</span> <span class="paren1">(<span class="code"></span>)</span>
<span class="atom">&gt;</span> prepare_s01_variants <span class="keyword">=</span> withSC3 <span class="atom">$</span> <span class="keyword">\</span>fd <span class="keyword">-&gt;</span>
<span class="atom">&gt;</span>   mapM_ <span class="paren1">(<span class="code"><span class="keyword">\</span><span class="paren2">(<span class="code">n,u</span>)</span> <span class="keyword">-&gt;</span> async fd <span class="atom">$</span> d_recv <span class="atom">$</span> synthdef n u</span>)</span>
<span class="atom">&gt;</span>     <span class="paren1">[<span class="code"> <span class="paren2">(<span class="code"><span class="string">"s01_alpha"</span>,upu <span class="string">"pan"</span> 1 <span class="atom">$</span> upu <span class="string">"freq"</span> 880 s01</span>)</span>
<span class="atom">&gt;</span>     , <span class="paren2">(<span class="code"><span class="string">"s01_beta"</span>, upu <span class="string">"pan"</span> <span class="paren3">(<span class="code"><span class="atom">-</span>1</span>)</span> <span class="atom">$</span> upu <span class="string">"freq"</span> 1320 s01</span>)</span>
<span class="atom">&gt;</span>     , <span class="paren2">(<span class="code"><span class="string">"s01_gamma"</span>,upu <span class="string">"freq"</span> 2640 s01</span>)</span> </span>]</span></span></code></pre>

<p>Parameters in <code>play_variants_01</code> are specified in message list,
parameters in <code>play_variants_02</code> are predefined in synth definition.
When sending lots of <code>s_new</code> messages with fixed value variations,
predefined approach will same the amount of data transfered to server,
since it contains no parameter values in message body.</p>

<pre><code><span class="code"><span class="atom">&gt;</span> play_variants_01 <span class="keyword">::</span> <span class="variable">IO</span> <span class="paren1">(<span class="code"></span>)</span>
<span class="atom">&gt;</span> play_variants_01 <span class="keyword">=</span> withSC3 <span class="atom">$</span> <span class="keyword">\</span>fd <span class="keyword">-&gt;</span>
<span class="atom">&gt;</span>   <span class="keyword">let</span> ms <span class="keyword">=</span> <span class="paren1">[<span class="code"> <span class="paren2">[<span class="code"><span class="paren3">(<span class="code"><span class="string">"freq"</span>,880</span>)</span>,<span class="paren3">(<span class="code"><span class="string">"pan"</span>,1</span>)</span></span>]</span>
<span class="atom">&gt;</span>            , <span class="paren2">[<span class="code"><span class="paren3">(<span class="code"><span class="string">"freq"</span>, 1320</span>)</span>,<span class="paren3">(<span class="code"><span class="string">"pan"</span>,<span class="atom">-</span>1</span>)</span></span>]</span>
<span class="atom">&gt;</span>            , <span class="paren2">[<span class="code"><span class="paren3">(<span class="code"><span class="string">"freq"</span>,2640</span>)</span></span>]</span>
<span class="atom">&gt;</span>            , <span class="paren2">[<span class="code"><span class="paren3">(<span class="code"><span class="string">"freq"</span>, 1320</span>)</span>,<span class="paren3">(<span class="code"><span class="string">"pan"</span>,<span class="atom">-</span>1</span>)</span></span>]</span>
<span class="atom">&gt;</span>            , <span class="paren2">[<span class="code"><span class="paren3">(<span class="code"><span class="string">"freq"</span>,2640</span>)</span></span>]</span>
<span class="atom">&gt;</span>            , <span class="paren2">[<span class="code"><span class="paren3">(<span class="code"><span class="string">"freq"</span>,880</span>)</span>,<span class="paren3">(<span class="code"><span class="string">"pan"</span>,1</span>)</span></span>]</span> </span>]</span>
<span class="atom">&gt;</span>   <span class="keyword">in</span>  forM_ ms <span class="atom">$</span> <span class="keyword">\</span>m <span class="keyword">-&gt;</span>
<span class="atom">&gt;</span>         send fd <span class="paren1">(<span class="code">s_new <span class="string">"s01"</span> <span class="paren2">(<span class="code"><span class="atom">-</span>1</span>)</span> <span class="variable">AddToTail</span> 1 m</span>)</span> <span class="atom">&gt;&gt;</span> threadDelay <span class="paren1">(<span class="code">5<span class="atom">*</span>10<span class="atom">^</span>5</span>)</span>
<span class="atom">&gt;</span>
<span class="atom">&gt;</span> play_variants_02 <span class="keyword">::</span> <span class="variable">IO</span> <span class="paren1">(<span class="code"></span>)</span>
<span class="atom">&gt;</span> play_variants_02 <span class="keyword">=</span> withSC3 <span class="atom">$</span> <span class="keyword">\</span>fd <span class="keyword">-&gt;</span>
<span class="atom">&gt;</span>   <span class="keyword">let</span> ds <span class="keyword">=</span> <span class="paren1">[<span class="code"> <span class="string">"s01_alpha"</span>, <span class="string">"s01_beta"</span>, <span class="string">"s01_gamma"</span>
<span class="atom">&gt;</span>            , <span class="string">"s01_beta"</span>, <span class="string">"s01_gamma"</span>, <span class="string">"s01_alpha"</span> </span>]</span>
<span class="atom">&gt;</span>   <span class="keyword">in</span>  forM_ ds <span class="atom">$</span> <span class="keyword">\</span>d <span class="keyword">-&gt;</span>
<span class="atom">&gt;</span>         send fd <span class="paren1">(<span class="code">s_new d <span class="paren2">(<span class="code"><span class="atom">-</span>1</span>)</span> <span class="variable">AddToTail</span> 1 <span class="paren2">[<span class="code"></span>]</span></span>)</span> <span class="atom">&gt;&gt;</span> threadDelay <span class="paren1">(<span class="code">5<span class="atom">*</span>10<span class="atom">^</span>5</span>)</span></span></code></pre>

<p>Another usage of generic update approach is, <code>UGen</code> replacing.</p>

<p>There are couple oscillator functions with type 'Rate -&gt; UGen -&gt; UGen
-&gt; UGen':</p>

<pre><code>| sinOsc :: Rate -&gt; UGen -&gt; UGen -&gt; UGen
| lfCub :: Rate -&gt; UGen -&gt; UGen -&gt; UGen
| lfPar :: Rate -&gt; UGen -&gt; UGen -&gt; UGen
| lfSaw :: Rate -&gt; UGen -&gt; UGen -&gt; UGen
| lfTri :: Rate -&gt; UGen -&gt; UGen -&gt; UGen
</code></pre>

<p>We can write a function taking these oscillator:</p>

<pre><code><span class="code"><span class="atom">&gt;</span> mks02 o <span class="keyword">=</span>
<span class="atom">&gt;</span>  <span class="keyword">let</span> s <span class="keyword">=</span> pan2 <span class="paren1">(<span class="code">o <span class="variable">AR</span> f 0 <span class="atom">*</span> e <span class="atom">*</span> 0<span class="atom">.</span>3</span>)</span> p 1
<span class="atom">&gt;</span>      e <span class="keyword">=</span> envGen <span class="variable">KR</span> 1 1 0 1 <span class="variable">RemoveSynth</span> <span class="paren1">(<span class="code">envPerc 1e<span class="atom">-</span>2 1</span>)</span>
<span class="atom">&gt;</span>      f <span class="keyword">=</span> control <span class="variable">KR</span> <span class="string">"freq"</span> 440
<span class="atom">&gt;</span>      p <span class="keyword">=</span> control <span class="variable">KR</span> <span class="string">"pan"</span> 0
<span class="atom">&gt;</span>  <span class="keyword">in</span>  out 0 s</span></code></pre>

<p>and play it:</p>

<pre><code><span class="code"><span class="atom">&gt;</span> play_s02_c <span class="keyword">=</span> audition <span class="atom">$</span> mks02 lfCub
<span class="atom">&gt;</span> play_s02_t <span class="keyword">=</span> audition <span class="atom">$</span> mks02 lfTri
<span class="atom">&gt;</span> play_s02_s <span class="keyword">=</span> audition <span class="atom">$</span> mks02 lfSaw</span></code></pre>

<p>We can do similar thing without passing function as an argument. <code>UGen</code>
functions <code>sinOsc</code>, <code>lfCub</code>, <code>lfPar</code>, <code>lfSaw</code>, <code>lfTri</code> are defined with
<code>Primitive</code> constructor:</p>

<pre><code>| *AdhocUpdate&gt; sinOsc AR 440 0
| Primitive { ugenRate = AR
|           , ugenName = &quot;SinOsc&quot;
|           , ugenInputs = [Constant {constantValue = 4400.0}
|                          ,Constant {constantValue = 0.0}]
|           , ugenOutputs = [AR], ugenSpecial = Special 0, ugenId = -1}
</code></pre>

<p>A function to update <code>Primitive</code>:</p>

<pre><code><span class="code"><span class="atom">&gt;</span> primu <span class="keyword">::</span> <span class="variable">String</span> <span class="keyword">-&gt;</span> <span class="variable">String</span> <span class="keyword">-&gt;</span> <span class="variable">UGen</span> <span class="keyword">-&gt;</span> <span class="variable">UGen</span>
<span class="atom">&gt;</span> primu from to ug <span class="keyword">=</span> transform f ug <span class="keyword">where</span>
<span class="atom">&gt;</span>   f p<span class="keyword">@</span><span class="paren1">(<span class="code"><span class="variable">Primitive</span> r n is os s idx</span>)</span> <span class="keyword">|</span> n <span class="atom">==</span> from <span class="keyword">=</span> p <span class="paren1">{<span class="code">ugenName <span class="keyword">=</span> to</span>}</span>
<span class="atom">&gt;</span>   f x <span class="keyword">=</span> x</span></code></pre>

<p>Using <code>primu</code>, we can update <code>sinOsc</code> used in <code>s01</code> to different
oscillator.</p>

<pre><code><span class="code"><span class="atom">&gt;</span> set_osc_s01 <span class="keyword">::</span> <span class="variable">String</span> <span class="keyword">-&gt;</span> <span class="variable">UGen</span>
<span class="atom">&gt;</span> set_osc_s01 <span class="keyword">=</span> flip <span class="paren1">(<span class="code">primu <span class="string">"SinOsc"</span></span>)</span> s01
<span class="atom">&gt;</span>
<span class="atom">&gt;</span> play_s01_cub, play_s01_tri, play_s01_saw <span class="keyword">::</span> <span class="variable">IO</span> <span class="paren1">(<span class="code"></span>)</span>
<span class="atom">&gt;</span> play_s01_cub <span class="keyword">=</span> audition <span class="atom">$</span> set_osc_s01 <span class="string">"LFCub"</span>
<span class="atom">&gt;</span> play_s01_tri <span class="keyword">=</span> audition <span class="atom">$</span> set_osc_s01 <span class="string">"LFTri"</span>
<span class="atom">&gt;</span> play_s01_saw <span class="keyword">=</span> audition <span class="atom">$</span> set_osc_s01 <span class="string">"LFSaw"</span></span></code></pre>

<p>By using <code>String</code> to specify <code>UGen</code> name, we loosed type safety. We can
have chance to send a <code>UGen</code> graph that does not work.</p>

<pre><code><span class="code"><span class="atom">&gt;</span> s01_ng1 <span class="keyword">=</span> set_osc_s01 <span class="string">"NoSuchUnitGenerator"</span></span></code></pre>

<p>Invoking <code>audition s01_ng1</code> will show an error message in scsynth:</p>

<pre><code>exception in GraphDef_Recv: UGen 'NoSuchUnitGenerator' not installed.
</code></pre>

<p>There's another chance to send malformed UGen graph, to update a ugen
with different inputs. <code>UGen</code> function <code>phasor</code> has type:</p>

<pre><code>| phasor :: Rate -&gt; UGen -&gt; UGen -&gt; UGen -&gt; UGen -&gt; UGen -&gt; UGen
</code></pre>

<p>Its type is different from <code>sinOsc</code>:</p>

<pre><code>| sinOsc :: Rate -&gt; UGen -&gt; UGen -&gt; UGen
</code></pre>

<p>Though, we can update <code>&quot;SinOsc&quot;</code> with <code>&quot;Phasor&quot;</code>.</p>

<pre><code><span class="code"><span class="atom">&gt;</span> s01_ng2 <span class="keyword">=</span> primu <span class="string">"SinOsc"</span> <span class="string">"Phasor"</span> s01</span></code></pre>

<p>Again, this likely to give us unintended result. Is there any safer way
to do this?</p>

<p>We can pass oscillator function instead of <code>String</code> to get the name of
<code>UGen</code>. <code>&quot;LFCub&quot;</code> string literal used in above <code>play_s01_cub</code> was picked
up from this result:</p>

<pre><code>| *AdhocUpdate&gt; lfCub AR 440 0
</code></pre>

<p>Let us call this type as <code>OscUG</code>.</p>

<pre><code><span class="code"><span class="atom">&gt;</span> <span class="keyword">type</span> <span class="variable">OscUG</span> <span class="keyword">=</span> <span class="variable">Rate</span> <span class="keyword">-&gt;</span> <span class="variable">UGen</span> <span class="keyword">-&gt;</span> <span class="variable">UGen</span> <span class="keyword">-&gt;</span> <span class="variable">UGen</span></span></code></pre>

<p>Rewrite <code>set_osc_s01</code> to:</p>

<pre><code><span class="code"><span class="atom">&gt;</span> set_osc_s01' <span class="keyword">::</span> <span class="variable">OscUG</span> <span class="keyword">-&gt;</span> <span class="variable">UGen</span>
<span class="atom">&gt;</span> set_osc_s01' o <span class="keyword">=</span> primu <span class="string">"SinOsc"</span> <span class="paren1">(<span class="code">oscName o</span>)</span> s01
<span class="atom">&gt;</span>
<span class="atom">&gt;</span> oscName <span class="keyword">::</span> <span class="variable">OscUG</span> <span class="keyword">-&gt;</span> <span class="variable">String</span>
<span class="atom">&gt;</span> oscName o <span class="keyword">=</span> ugenName <span class="paren1">(<span class="code">o <span class="variable">AR</span> 0 0</span>)</span></span></code></pre>

<p>Note the use of dummy arguments <code>AR</code>, <code>0</code>, and <code>0</code>. Using <code>oscName</code>,
<code>OscUG</code> could be shown as <code>String</code>. Make it an instance of <code>Show</code> class.</p>

<pre><code><span class="code"><span class="atom">&gt;</span> <span class="keyword">instance</span> <span class="variable">Show</span> <span class="variable">OscUG</span> <span class="keyword">where</span>
<span class="atom">&gt;</span>   show <span class="keyword">=</span> oscName</span></code></pre>

<p>We can write a function to swap all occurance of <code>OscUG</code> s.</p>

<pre><code><span class="code"><span class="atom">&gt;</span> swapOsc <span class="keyword">::</span> <span class="variable">OscUG</span> <span class="keyword">-&gt;</span> <span class="variable">OscUG</span> <span class="keyword">-&gt;</span> <span class="variable">UGen</span> <span class="keyword">-&gt;</span> <span class="variable">UGen</span>
<span class="atom">&gt;</span> swapOsc from to ug <span class="keyword">=</span> primu <span class="paren1">(<span class="code">oscName from</span>)</span> <span class="paren1">(<span class="code">oscName to</span>)</span> ug</span></code></pre>

<p>Below will swap all <code>sinOsc</code> to <code>lfSaw</code> in <code>s01</code>.</p>

<pre><code><span class="code"><span class="atom">&gt;</span> play_s01_saw' <span class="keyword">::</span> <span class="variable">IO</span> <span class="paren1">(<span class="code"></span>)</span>
<span class="atom">&gt;</span> play_s01_saw'<span class="keyword">=</span> audition <span class="atom">$</span> swapOsc sinOsc lfSaw s01</span></code></pre>

<p>Example usage of <code>swapOsc</code>, randomly replacing <code>sinOsc</code>.</p>

<pre><code><span class="code"><span class="atom">&gt;</span> oscUGs <span class="keyword">::</span> <span class="paren1">[<span class="code"><span class="variable">OscUG</span></span>]</span>
<span class="atom">&gt;</span> oscUGs <span class="keyword">=</span> <span class="paren1">[<span class="code">sinOsc,fSinOsc,lfPar,lfCub,lfTri,lfSaw</span>]</span>
<span class="atom">&gt;</span>
<span class="atom">&gt;</span> randomOscUG <span class="keyword">::</span> <span class="variable">RandomGen</span> g <span class="atom">=&gt;</span> g <span class="keyword">-&gt;</span> <span class="paren1">(<span class="code"><span class="variable">OscUG,</span> g</span>)</span>
<span class="atom">&gt;</span> randomOscUG g <span class="keyword">=</span> <span class="keyword">case</span> randomR <span class="paren1">(<span class="code">0, length oscUGs <span class="atom">-</span> 1</span>)</span> g <span class="keyword">of</span>
<span class="atom">&gt;</span>     <span class="paren1">(<span class="code">i,g'</span>)</span> <span class="keyword">-&gt;</span> <span class="paren1">(<span class="code">oscUGs <span class="atom">!!</span> i, g'</span>)</span></span></code></pre>

<p><code>randomOscUG</code> will randomly return oscillators:</p>

<pre><code>| *AdhocUpdate&gt; replicateM 5 (getStdRandom randomOscUG)
| [LFPar,FSinOsc,LFSaw,FSinOsc,LFPar]
</code></pre>

<p>Make a synth containing 30 sinOscs.</p>

<pre><code><span class="code"><span class="atom">&gt;</span> s03 <span class="keyword">::</span> <span class="variable">Double</span> <span class="keyword">-&gt;</span> <span class="variable">UGen</span>
<span class="atom">&gt;</span> s03 ff <span class="keyword">=</span>
<span class="atom">&gt;</span>   <span class="keyword">let</span> mko f a d <span class="keyword">=</span> sinOsc <span class="variable">AR</span> <span class="paren1">(<span class="code">mkf f</span>)</span> 0 <span class="atom">*</span> <span class="paren1">(<span class="code">mke a d</span>)</span> <span class="atom">*</span> 0<span class="atom">.</span>01
<span class="atom">&gt;</span>       mkf f <span class="keyword">=</span> constant f
<span class="atom">&gt;</span>       mke a d <span class="keyword">=</span> envGen <span class="variable">KR</span> 1 1 0 1 <span class="variable">DoNothing</span> <span class="atom">$</span> envSine a d
<span class="atom">&gt;</span>       me <span class="keyword">=</span> envGen <span class="variable">KR</span> 1 0 1 1 <span class="variable">RemoveSynth</span> <span class="atom">$</span> envLinen 0 5 2<span class="atom">.</span>5 1
<span class="atom">&gt;</span>       os <span class="keyword">=</span> zipWith3 mko
<span class="atom">&gt;</span>            <span class="paren1">[<span class="code">x<span class="atom">*</span>1<span class="atom">.</span>2081 <span class="keyword">|</span> x <span class="keyword">&lt;-</span> <span class="paren2">[<span class="code">ff,ff<span class="atom">*</span>2<span class="keyword">..</span></span>]</span></span>]</span>
<span class="atom">&gt;</span>            <span class="paren1">[<span class="code">1<span class="atom">.</span>25<span class="atom">**</span>x  <span class="keyword">|</span> x <span class="keyword">&lt;-</span> <span class="paren2">[<span class="code">1,2<span class="keyword">..</span></span>]</span></span>]</span>
<span class="atom">&gt;</span>            <span class="paren1">[<span class="code">2<span class="atom">.</span>5<span class="atom">*</span>x    <span class="keyword">|</span> x <span class="keyword">&lt;-</span> <span class="paren2">[<span class="code">10,9<span class="keyword">..</span></span>]</span></span>]</span>
<span class="atom">&gt;</span>       sig <span class="keyword">=</span> <span class="paren1">(<span class="code">mix <span class="atom">$</span> mce <span class="atom">$</span> take 30 os</span>)</span> <span class="atom">*</span> me
<span class="atom">&gt;</span>   <span class="keyword">in</span>  out 0 <span class="paren1">(<span class="code">pan2 sig 0 1</span>)</span></span></code></pre>

<p>And a function to randomly replace <code>sinOsc</code> with <code>getStdRandom</code>.</p>

<pre><code><span class="code"><span class="atom">&gt;</span> randomizeOsc <span class="keyword">::</span> <span class="variable">UGen</span> <span class="keyword">-&gt;</span> <span class="variable">IO</span> <span class="variable">UGen</span>
<span class="atom">&gt;</span> randomizeOsc ug <span class="keyword">=</span> transformM k ug <span class="keyword">where</span>
<span class="atom">&gt;</span>   k <span class="paren1">(<span class="code"><span class="variable">Primitive</span> r n is os s j</span>)</span>
<span class="atom">&gt;</span>     <span class="keyword">|</span> n <span class="atom">==</span> <span class="string">"SinOsc"</span> <span class="keyword">=</span> getStdRandom randomOscUG <span class="atom">&gt;&gt;=</span> <span class="keyword">\</span>o <span class="keyword">-&gt;</span>
<span class="atom">&gt;</span>       return <span class="atom">$</span> <span class="variable">Primitive</span> r <span class="paren1">(<span class="code">oscName o</span>)</span> is os s j
<span class="atom">&gt;</span>   k x <span class="keyword">=</span> return x</span></code></pre>

<p>Takes fundamental frequency and play sum of oscillators. Oscillators
used for each partial are choosed randomly.</p>

<pre><code><span class="code"><span class="atom">&gt;</span> play_s03_rand <span class="keyword">::</span> <span class="variable">Double</span> <span class="keyword">-&gt;</span> <span class="variable">IO</span> <span class="paren1">(<span class="code"></span>)</span>
<span class="atom">&gt;</span> play_s03_rand x <span class="keyword">=</span> audition <span class="atom">=&lt;&lt;</span> randomizeOsc <span class="paren1">(<span class="code">s03 x</span>)</span></span></code></pre>

<p>Invoking:</p>

<pre><code>| *AdhocUpdate&gt; play_s03_rand 30
</code></pre>

<p>will build a UGen graph with randomly chosen oscillator UGen for each
partial.</p>

<p>Variation without using generic update. Type signature of this synth is
<code>IO UGen</code>, since its callling <code>randomOscUG</code> inside.</p>

<pre><code><span class="code"><span class="atom">&gt;</span> s03' <span class="keyword">::</span> <span class="variable">Double</span> <span class="keyword">-&gt;</span> <span class="variable">IO</span> <span class="variable">UGen</span>
<span class="atom">&gt;</span> s03' ff <span class="keyword">=</span> <span class="keyword">do</span>
<span class="atom">&gt;</span>   ougs <span class="keyword">&lt;-</span> replicateM 30 <span class="paren1">(<span class="code">getStdRandom randomOscUG</span>)</span>
<span class="atom">&gt;</span>   <span class="keyword">let</span> mko o f a d <span class="keyword">=</span> o <span class="variable">AR</span> <span class="paren1">(<span class="code">mkf f</span>)</span> 0 <span class="atom">*</span> <span class="paren1">(<span class="code">mke a d</span>)</span> <span class="atom">*</span> 0<span class="atom">.</span>01
<span class="atom">&gt;</span>       mkf f <span class="keyword">=</span> constant f
<span class="atom">&gt;</span>       mke a d <span class="keyword">=</span> envGen <span class="variable">KR</span> 1 1 0 1 <span class="variable">DoNothing</span> <span class="atom">$</span> envSine a d
<span class="atom">&gt;</span>       me <span class="keyword">=</span> envGen <span class="variable">KR</span> 1 0 1 1 <span class="variable">RemoveSynth</span> <span class="atom">$</span> envLinen 0 5 2<span class="atom">.</span>5 1
<span class="atom">&gt;</span>       os <span class="keyword">=</span> zipWith4 mko
<span class="atom">&gt;</span>            ougs
<span class="atom">&gt;</span>            <span class="paren1">[<span class="code">x<span class="atom">*</span>1<span class="atom">.</span>2081 <span class="keyword">|</span> x <span class="keyword">&lt;-</span> <span class="paren2">[<span class="code">ff,ff<span class="atom">*</span>2<span class="keyword">..</span></span>]</span></span>]</span>
<span class="atom">&gt;</span>            <span class="paren1">[<span class="code">1<span class="atom">.</span>25<span class="atom">**</span>x  <span class="keyword">|</span> x <span class="keyword">&lt;-</span> <span class="paren2">[<span class="code">1,2<span class="keyword">..</span></span>]</span></span>]</span>
<span class="atom">&gt;</span>            <span class="paren1">[<span class="code">2<span class="atom">.</span>5<span class="atom">*</span>x    <span class="keyword">|</span> x <span class="keyword">&lt;-</span> <span class="paren2">[<span class="code">10,9<span class="keyword">..</span></span>]</span></span>]</span>
<span class="atom">&gt;</span>       sig <span class="keyword">=</span> <span class="paren1">(<span class="code">mix <span class="atom">$</span> mce os</span>)</span> <span class="atom">*</span> me
<span class="atom">&gt;</span>   return <span class="atom">$</span> out 0 <span class="paren1">(<span class="code">pan2 sig 0 1</span>)</span></span></code></pre>

<p>The result UGen graph is different from <code>s03</code>. Since <code>s03</code> may replaces
oscillator used for left and right of same frequency with different
oscillators. s03' uses same oscillator for left and right of same
frequency.</p>

<pre><code><span class="code"><span class="atom">&gt;</span> play_s03_rand' <span class="keyword">::</span> <span class="variable">Double</span> <span class="keyword">-&gt;</span> <span class="variable">IO</span> <span class="paren1">(<span class="code"></span>)</span>
<span class="atom">&gt;</span> play_s03_rand' x <span class="keyword">=</span> audition <span class="atom">=&lt;&lt;</span> s03' x</span></code></pre>
 </div> <div class="post-tags"> TAGGED: <a href="/tag/haskell.html">haskell</a>, <a href="/tag/supercollider.html">supercollider</a>, <a href="/tag/generic.html">generic</a> </div> <div class="prev-post-link"> Prev: <a href="/posts/Another-instance-deriving-example-with-template-haskell.html">Another instance deriving example with template haskell</a> </div> <div class="next-post-link"> Next: <a href="/posts/Bytestring-and-unicode-chars-from-U0080-to-U00FF.html">Bytestring and unicode chars from U+0080 to U+00FF</a> </div> </div> <footer> <section class="tags"> <h3>Tags</h3> <a href="/tag/algorithm.html">algorithm</a> • <a href="/tag/arc.html">arc</a> • <a href="/tag/arrow.html">arrow</a> • <a href="/tag/cabal.html">cabal</a> • <a href="/tag/ci.html">ci</a> • <a href="/tag/coleslaw.html">coleslaw</a> • <a href="/tag/commonlisp.html">commonlisp</a> • <a href="/tag/continuation.html">continuation</a> • <a href="/tag/datastructure.html">datastructure</a> • <a href="/tag/delimited.html">delimited</a> • <a href="/tag/dph.html">dph</a> • <a href="/tag/dsl.html">dsl</a> • <a href="/tag/emacs.html">emacs</a> • <a href="/tag/french.html">french</a> • <a href="/tag/functionaldependency.html">functionaldependency</a> • <a href="/tag/generic.html">generic</a> • <a href="/tag/ghc.html">ghc</a> • <a href="/tag/ghci.html">ghci</a> • <a href="/tag/git.html">git</a> • <a href="/tag/hakyll.html">hakyll</a> • <a href="/tag/haskell.html">haskell</a> • <a href="/tag/heroku.html">heroku</a> • <a href="/tag/image.html">image</a> • <a href="/tag/linux.html">linux</a> • <a href="/tag/lisp.html">lisp</a> • <a href="/tag/monad.html">monad</a> • <a href="/tag/package.html">package</a> • <a href="/tag/pdf.html">pdf</a> • <a href="/tag/performance.html">performance</a> • <a href="/tag/ps.html">ps</a> • <a href="/tag/repa.html">repa</a> • <a href="/tag/sound.html">sound</a> • <a href="/tag/supercollider.html">supercollider</a> • <a href="/tag/templatehaskell.html">templatehaskell</a> • <a href="/tag/tips.html">tips</a> • <a href="/tag/travis.html">travis</a> • <a href="/tag/tree.html">tree</a> • <a href="/tag/typefamily.html">typefamily</a> • <a href="/tag/utf-8.html">utf-8</a> • <a href="/tag/web.html">web</a> </section> Copyright © 2011-2017 8c6794b6; Unless otherwise noted, site contents licensed under <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"> CC-by-SA</a>. </footer> </body> </html>