<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>8c6794b6.github.com - Calling itself as a dependency in cabal package</title>
    <link rel="shortcut icon" href="../favicon.ico" type="image/x-icon">
    <link rel="icon" href="favicon.ico" type="image/ico">
    <link rel="stylesheet" type="text/css" href="../css/style.css">
    <link rel="stylesheet" type="text/css" href="../css/hk-tango.css">
    <link rel="alternate" type="application/rss+xml" title="8c6794b6" href="../rss.xml">
  </head>
  <body>
    <div>
      <div id="header">
        <div id="header_contents">
          <div id="header_left">
            <a href="../">8c6794b6.github.com</a>
          </div>
          <div id="navigation">
            <a href="../index.html">Home</a>
            <a href="../archive.html">Archive</a>
            <a href="../rss.xml">RSS</a>
          </div>
        </div>
      </div>

      <div id="content">

        <h1>Calling itself as a dependency in cabal package</h1>
<div id="post_date">
  <strong>March 24, 2012</strong>
</div>

<div id="post_body">
<p>For self reminder. When we’re creating cabal package, sometime we want to call itself as a depdency, for instance when making a package with library and bundled executable, using cabal’s test-suite feature.</p>
<p>For quite a while I didn’t realise that we can call itself as dependency and suppress compiling the whole library modules used in exectuables and tests. The trick was, <em>separating the directory containing library source and executable source</em> in single package.</p>
<p>Sample cabal config:</p>
<pre class="sourceCode literate haskell"><code class="sourceCode haskell"><span class="fu">&gt;</span> name<span class="fu">:</span>          selfdep
<span class="fu">&gt;</span> build<span class="fu">-</span><span class="kw">type</span><span class="fu">:</span>    <span class="dt">Simple</span>
<span class="fu">&gt;</span> cabal<span class="fu">-</span>version<span class="fu">:</span> <span class="fu">&gt;=</span><span class="fl">1.8</span>
<span class="fu">&gt;</span> 
<span class="fu">&gt;</span> library
<span class="fu">&gt;</span>   exposed<span class="fu">-</span>modules<span class="fu">:</span>
<span class="fu">&gt;</span>     <span class="dt">Self.Dep</span>
<span class="fu">&gt;</span>     <span class="dt">Self.Dep.Foo</span>
<span class="fu">&gt;</span>     <span class="dt">Self.Dep.Bar</span>
<span class="fu">&gt;</span>   build<span class="fu">-</span>depends<span class="fu">:</span>
<span class="fu">&gt;</span>     base       <span class="fu">&gt;=</span> <span class="fl">4.4</span> <span class="fu">&amp;&amp;</span> <span class="fu">&lt;</span> <span class="dv">5</span>,
<span class="fu">&gt;</span>     containers <span class="fu">&gt;=</span> <span class="fl">0.4</span> <span class="fu">&amp;&amp;</span> <span class="fu">&lt;</span> <span class="fl">1.0</span>
<span class="fu">&gt;</span> 
<span class="fu">&gt;</span> test<span class="fu">-</span>suite tests
<span class="fu">&gt;</span>   <span class="kw">type</span><span class="fu">:</span> exitcode<span class="fu">-</span>stdio<span class="dv">-1</span><span class="fu">.</span><span class="dv">0</span>
<span class="fu">&gt;</span>   hs<span class="fu">-</span>source<span class="fu">-</span>dirs<span class="fu">:</span> tests
<span class="fu">&gt;</span>   main<span class="fu">-</span>is<span class="fu">:</span> test<span class="fu">.</span>hs
<span class="fu">&gt;</span>   build<span class="fu">-</span>depends<span class="fu">:</span>
<span class="fu">&gt;</span>     base       <span class="fu">&gt;=</span> <span class="fl">4.4</span> <span class="fu">&amp;&amp;</span> <span class="fu">&lt;</span> <span class="dv">5</span>,
<span class="fu">&gt;</span>     <span class="dt">QuickCheck</span> <span class="fu">&gt;=</span> <span class="fl">2.4</span> <span class="fu">&amp;&amp;</span> <span class="fu">&lt;</span> <span class="dv">3</span>,
<span class="fu">&gt;</span>     selfdep <span class="fu">-any</span>
<span class="fu">&gt;</span> 
<span class="fu">&gt;</span> executable foo
<span class="fu">&gt;</span>   hs<span class="fu">-</span>source<span class="fu">-</span>dirs<span class="fu">:</span> run
<span class="fu">&gt;</span>   main<span class="fu">-</span>is<span class="fu">:</span> foo<span class="fu">.</span>hs
<span class="fu">&gt;</span>   build<span class="fu">-</span>depends<span class="fu">:</span>
<span class="fu">&gt;</span>     base    <span class="fu">&gt;=</span> <span class="fl">4.4</span> <span class="fu">&amp;&amp;</span> <span class="fu">&lt;</span> <span class="dv">5</span>,
<span class="fu">&gt;</span>     selfdep <span class="fu">-any</span></code></pre>
<p>In file <code>foo.hs</code>, module <code>Self.Dep.Foo</code> is imported:</p>
<pre><code>$ cat run/foo.hs
module Main where

import qualified Self.Dep.Foo

main :: IO ()
main = print Self.Dep.Foo.foo</code></pre>
<p>Building the package:</p>
<pre><code>$ cabal configure &amp;&amp; cabal build
Resolving dependencies...
Configuring selfdep-0.1.0.0...
Building selfdep-0.1.0.0...
Preprocessing library selfdep-0.1.0.0...
[1 of 3] Compiling Self.Dep.Bar     ( Self/Dep/Bar.hs, dist/build/Self/Dep/Bar.o )
[2 of 3] Compiling Self.Dep.Foo     ( Self/Dep/Foo.hs, dist/build/Self/Dep/Foo.o )
[3 of 3] Compiling Self.Dep         ( Self/Dep.hs, dist/build/Self/Dep.o )
Registering selfdep-0.1.0.0...
Preprocessing executable 'foo' for selfdep-0.1.0.0...
[1 of 1] Compiling Main             ( run/foo.hs, dist/build/foo/foo-tmp/Main.o )
Linking dist/build/foo/foo ...</code></pre>
<p>During the compilation of executable <code>foo</code>, modules under <code>Self.*</code> were not recompiled. This separation of the directory works also for tests.</p>
</div>

<div class="post_tags">
  <strong>Tags: </strong><a href="../tags/haskell.html">haskell</a>, <a href="../tags/cabal.html">cabal</a>, <a href="../tags/package.html">package</a>
</div>


      </div>
      <div id="footer">
        <div id="footer_content">
          <p>
            <a href="../index.html">Home</a> |
            <a href="../archive.html">Archive</a> |
            <a href="../rss.xml">RSS</a>
          </p>

          Site contents licensed under
          <a href="http://creativecommons.org/licenses/by/3.0/">
            CC Attribution 3.0
          </a>
        </div>
      </div>
    </div>
  </body>
</html>
